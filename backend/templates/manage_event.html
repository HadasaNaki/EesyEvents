{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-[color:var(--color-beige)] py-12">
    <div class="container px-4 md:px-8">

        <!-- Back Link -->
        <div class="mb-8 fade-in-up">
            <a href="/dashboard" class="text-gray-400 hover:text-[color:var(--color-black)] text-xs uppercase tracking-widest transition-colors">
                ← חזרה לאירועים שלי
            </a>
        </div>

        <!-- Event Header -->
        <div class="relative h-[400px] mb-12 fade-in-up overflow-hidden group shadow-2xl">
            <!-- Background Image -->
            <img src="{% if event.event_type == 'wedding' %}https://images.unsplash.com/photo-1519741497674-611481863552?q=80&w=1600&auto=format&fit=crop
                      {% elif event.event_type == 'bar-mitzvah' %}https://images.unsplash.com/photo-1530103862676-de3c9a59af57?q=80&w=1600&auto=format&fit=crop
                      {% elif event.event_type == 'brit' %}https://images.unsplash.com/photo-1519689680058-324335c77eba?q=80&w=1600&auto=format&fit=crop
                      {% elif event.event_type == 'engagement' %}https://images.unsplash.com/photo-1515934751635-c81c6bc9a2d8?q=80&w=1600&auto=format&fit=crop
                      {% elif event.event_type == 'party' %}https://images.unsplash.com/photo-1519671482538-518b5c2bf1c6?q=80&w=1600&auto=format&fit=crop
                      {% elif event.event_type == 'business' %}https://images.unsplash.com/photo-1511578314322-379afb476865?q=80&w=1600&auto=format&fit=crop
                      {% elif event.event_type == 'birthday' %}https://images.unsplash.com/photo-1464349153735-7db50ed83c84?q=80&w=1600&auto=format&fit=crop
                      {% else %}https://images.unsplash.com/photo-1511795409834-ef04bbd61622?q=80&w=1600&auto=format&fit=crop{% endif %}" 
                 class="absolute inset-0 w-full h-full object-cover transition-transform duration-1000 group-hover:scale-105 grayscale-[20%]">
            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-black/20"></div>
            
            <!-- Content Overlay -->
            <div class="absolute inset-0 flex flex-col justify-end p-8 md:p-16 text-white">
                <div class="container mx-auto max-w-6xl">
                    <div class="flex flex-col md:flex-row justify-between items-end gap-8">
                        <div>
                            <span class="inline-block px-4 py-1.5 mb-6 text-[10px] font-bold uppercase tracking-widest bg-white/10 backdrop-blur-md border border-white/20 text-white shadow-sm">
                                {{ event.status }}
                            </span>
                            <h1 class="font-serif text-5xl md:text-6xl mb-4 text-white drop-shadow-lg">
                                {% if event.event_type == 'wedding' %}חתונה
                                {% elif event.event_type == 'bar-mitzvah' %}בר/בת מצווה
                                {% elif event.event_type == 'brit' %}ברית/ה
                                {% elif event.event_type == 'engagement' %}אירוסין/חינה
                                {% elif event.event_type == 'party' %}מסיבה פרטית
                                {% elif event.event_type == 'business' %}אירוע עסקי
                                {% elif event.event_type == 'birthday' %}יום הולדת
                                {% else %}אירוע כללי{% endif %}
                            </h1>
                            <p class="text-white/90 font-light text-lg tracking-wide flex items-center gap-3">
                                <span>{{ event.date or 'תאריך לא נקבע' }}</span>
                                <span class="w-1 h-1 bg-white/50 rounded-full"></span>
                                <span>{{ event.guests or '?' }} אורחים</span>
                            </p>
                        </div>

                        <!-- Edit & Delete Buttons -->
                        <div class="absolute top-4 left-4 flex gap-2">
                            <button onclick="openEditModal()" class="px-4 py-2 bg-white/10 backdrop-blur-md border border-white/20 text-white hover:bg-white/20 transition-colors text-xs uppercase tracking-widest">
                                עריכה
                            </button>
                            <button onclick="confirmDeleteEvent()" class="px-4 py-2 bg-red-500/80 backdrop-blur-md border border-red-400/20 text-white hover:bg-red-600/80 transition-colors text-xs uppercase tracking-widest">
                                מחיקה
                            </button>
                        </div>

                        <!-- Stats -->
                        <div class="flex gap-4">
                            <div class="text-center px-8 py-4 bg-white/10 backdrop-blur-md border border-white/20 min-w-[120px]">
                                <span class="block text-3xl font-serif text-white">{{ completed_count }}</span>
                                <span class="text-[10px] uppercase tracking-widest text-white/70">הושלמו</span>
                            </div>
                            <div class="text-center px-8 py-4 bg-white/10 backdrop-blur-md border border-white/20 min-w-[120px]">
                                <span class="block text-3xl font-serif text-white">{{ total_count }}</span>
                                <span class="text-[10px] uppercase tracking-widest text-white/70">משימות</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="mt-12 h-0.5 w-full bg-white/20 overflow-hidden">
                        <div class="h-full bg-white transition-all duration-1000 shadow-[0_0_15px_rgba(255,255,255,0.8)]" style="width: {{ (completed_count / total_count * 100) if total_count > 0 else 0 }}%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 fade-in-up delay-100">

            <!-- Checklist Section -->
            <div class="lg:col-span-2">
                <div class="bg-white p-8 shadow-sm border border-gray-100 min-h-[500px]">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="font-serif text-2xl text-[color:var(--color-black)]">רשימת משימות</h2>
                        <button onclick="openAddItemModal()" class="text-[color:var(--color-black)] hover:bg-gray-50 p-2 rounded-full transition-colors text-xl">+</button>
                    </div>

                    <!-- Checklist Items -->
                                        <!-- Checklist Items -->
                    <div class="space-y-4" id="checklist-container">
                        {% for item in checklist_items %}
                        <div class="group flex items-center gap-4 p-5 border-b border-gray-50 hover:bg-gray-50 transition-all" id="item-{{ item.id }}">
                            <label class="cursor-pointer relative flex items-center">
                                <input type="checkbox"
                                       class="peer sr-only"
                                       {% if item.is_completed %}checked{% endif %}
                                       onchange="toggleItem({{ item.id }}, this.checked)">
                                <div class="w-5 h-5 border border-[color:var(--color-almond)] peer-checked:border-[color:var(--color-espresso)] peer-checked:bg-[color:var(--color-espresso)] transition-all flex items-center justify-center rounded-sm">
                                    <svg class="w-3 h-3 text-white opacity-0 peer-checked:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                </div>
                            </label>

                            <span class="flex-grow font-sans text-[color:var(--color-coffee)] peer-checked:text-gray-400 peer-checked:line-through transition-colors text-lg">
                                {{ item.title }}
                            </span>

                            <button onclick="deleteItem({{ item.id }})" class="text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-all px-2">
                                ×
                            </button>
                        </div>
                        {% else %}
                        <div class="text-center py-16 text-gray-400">
                            <p class="font-serif text-xl mb-2">הרשימה ריקה</p>
                            <p class="text-sm mb-6">התחל לתכנן את האירוע שלך</p>
                            <button onclick="openAddItemModal()" class="text-[color:var(--color-espresso)] border-b border-[color:var(--color-espresso)] pb-0.5 hover:opacity-70 transition-opacity text-sm uppercase tracking-widest">הוסף משימה ראשונה</button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Sidebar (Budget / Vendors Summary - Placeholder for next steps) -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Budget Summary -->
                <div class="bg-white p-8 shadow-sm border border-gray-100">
                    <h3 class="font-serif text-xl mb-6 text-[color:var(--color-espresso)]">תקציב</h3>
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-gray-500 text-sm">תקציב משוער</span>
                        <span class="font-bold text-lg text-[color:var(--color-coffee)]">
                            {% if event.budget == 'low' %}50k
                            {% elif event.budget == 'medium' %}100k
                            {% elif event.budget == 'high' %}200k
                            {% elif event.budget == 'premium' %}350k
                            {% elif event.budget == 'luxury' %}350k+
                            {% else %}0{% endif %} ₪
                        </span>
                    </div>
                    <div class="w-full bg-gray-100 h-1 rounded-full overflow-hidden">
                        <div class="bg-[color:var(--color-caramel)] h-full w-0"></div>
                    </div>
                    <p class="text-xs text-gray-400 mt-4 text-center">ניהול תקציב יתווסף בקרוב</p>
                </div>

                <!-- Quick Actions -->
                <div class="bg-[color:var(--color-espresso)] p-8 text-white">
                    <h3 class="font-serif text-xl mb-6">פעולות מהירות</h3>
                    <ul class="space-y-4 text-sm font-sans tracking-wide">
                        <li><a href="/results" class="block hover:text-[color:var(--color-vanilla)] transition-colors flex items-center gap-2"><span class="text-[color:var(--color-caramel)]">→</span> חיפוש ספקים נוספים</a></li>
                        <li><button onclick="showVendorsList()" class="block hover:text-[color:var(--color-vanilla)] transition-colors text-left w-full flex items-center gap-2"><span class="text-[color:var(--color-caramel)]">→</span> הספקים שלי ({{ vendors|length }})</button></li>
                        <li><a href="#" onclick="alert('בקרוב - ניהול מוזמנים')" class="block hover:text-[color:var(--color-vanilla)] transition-colors flex items-center gap-2"><span class="text-[color:var(--color-caramel)]">→</span> ניהול מוזמנים</a></li>
                        <li><a href="#" onclick="alert('בקרוב - השראות ועיצוב')" class="block hover:text-[color:var(--color-vanilla)] transition-colors flex items-center gap-2"><span class="text-[color:var(--color-caramel)]">→</span> השראות ועיצוב</a></li>
                    </ul>
                </div>

                <!-- My Vendors Section -->
                <div class="bg-white p-8 shadow-sm border border-gray-100">
                    <h3 class="font-serif text-xl mb-6 text-[color:var(--color-espresso)]">הספקים שלי</h3>
                    {% if vendors %}
                    <div class="space-y-3">
                        {% for vendor in vendors %}
                        <div class="flex justify-between items-center p-4 border-b border-gray-100 hover:bg-gray-50 transition-colors">
                            <div class="flex-1">
                                <p class="font-bold text-sm text-[color:var(--color-coffee)]">{{ vendor.vendor_name }}</p>
                                <p class="text-xs text-gray-400 mt-1">{{ vendor.vendor_type }}</p>
                            </div>
                            <div class="text-left">
                                <p class="font-bold text-sm text-[color:var(--color-espresso)]">{{ vendor.vendor_price }} ₪</p>
                            </div>
                        </div>
                        {% endfor %}
                        <div class="pt-4 border-t-2 border-gray-200 flex justify-between items-center font-bold">
                            <span class="text-[color:var(--color-espresso)]">סה"כ</span>
                            <span class="text-lg text-[color:var(--color-espresso)]">
                                {{ vendors|sum(attribute='vendor_price') }} ₪
                            </span>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-8 text-gray-400">
                        <p class="text-sm mb-4">עדיין לא בחרת ספקים</p>
                        <a href="/results" class="text-xs text-[color:var(--color-espresso)] border-b border-[color:var(--color-espresso)] hover:opacity-70">חפש ספקים</a>
                    </div>
                    {% endif %}
                </div>
    </div>
</div>

<!-- Add Item Modal -->
<div id="addItemModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
    <div class="bg-white p-8 max-w-md w-full mx-4 shadow-2xl">
        <h3 class="font-serif text-2xl mb-6 text-[color:var(--color-black)]">הוספת משימה חדשה</h3>
        <input type="text" id="newItemTitle" placeholder="מה צריך לעשות?" class="w-full p-4 border border-gray-200 mb-6 outline-none focus:border-[color:var(--color-black)]">
        <div class="flex gap-4">
            <button onclick="closeAddItemModal()" class="flex-1 py-3 border border-gray-200 text-gray-500 hover:bg-gray-50 transition-colors">ביטול</button>
            <button onclick="addItem()" class="flex-1 py-3 bg-[color:var(--color-black)] text-white hover:opacity-90 transition-opacity">הוסף</button>
        </div>
    </div>
</div>

<!-- Edit Event Modal -->
<div id="editEventModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm overflow-y-auto">
    <div class="bg-white p-8 max-w-2xl w-full mx-4 my-8 shadow-2xl">
        <div class="flex justify-between items-center mb-8">
            <h3 class="font-serif text-2xl text-[color:var(--color-espresso)]">עריכת פרטי האירוע</h3>
            <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
        
        <form id="editEventForm" class="space-y-6">
            <!-- Event Type -->
            <div>
                <label class="block text-sm font-bold text-gray-600 mb-2 uppercase tracking-widest">סוג אירוע</label>
                <select id="editEventType" class="w-full p-4 border border-gray-200 outline-none focus:border-[color:var(--color-espresso)] bg-white">
                    <option value="wedding">חתונה</option>
                    <option value="bar-mitzvah">בר/בת מצווה</option>
                    <option value="brit">ברית/ה</option>
                    <option value="engagement">אירוסין/חינה</option>
                    <option value="party">מסיבה פרטית</option>
                    <option value="business">אירוע עסקי</option>
                    <option value="birthday">יום הולדת</option>
                    <option value="other">אחר</option>
                </select>
            </div>
            
            <!-- Date & Time -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-2 uppercase tracking-widest">תאריך</label>
                    <input type="date" id="editDate" class="w-full p-4 border border-gray-200 outline-none focus:border-[color:var(--color-espresso)]">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-2 uppercase tracking-widest">שעה</label>
                    <select id="editTimeOfDay" class="w-full p-4 border border-gray-200 outline-none focus:border-[color:var(--color-espresso)] bg-white">
                        <option value="">לא נקבע</option>
                        <option value="morning">בוקר</option>
                        <option value="noon">צהריים</option>
                        <option value="evening">ערב</option>
                        <option value="night">לילה</option>
                    </select>
                </div>
            </div>
            
            <!-- Guests & Budget -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-2 uppercase tracking-widest">מספר אורחים</label>
                    <input type="number" id="editGuests" placeholder="כמה אורחים?" class="w-full p-4 border border-gray-200 outline-none focus:border-[color:var(--color-espresso)]">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-2 uppercase tracking-widest">תקציב</label>
                    <select id="editBudget" class="w-full p-4 border border-gray-200 outline-none focus:border-[color:var(--color-espresso)] bg-white">
                        <option value="">לא נקבע</option>
                        <option value="low">עד 50,000 ₪</option>
                        <option value="medium">50,000 - 100,000 ₪</option>
                        <option value="high">100,000 - 200,000 ₪</option>
                        <option value="premium">200,000 - 350,000 ₪</option>
                        <option value="luxury">350,000+ ₪</option>
                    </select>
                </div>
            </div>
            
            <!-- Region -->
            <div>
                <label class="block text-sm font-bold text-gray-600 mb-2 uppercase tracking-widest">אזור</label>
                <select id="editRegion" class="w-full p-4 border border-gray-200 outline-none focus:border-[color:var(--color-espresso)] bg-white">
                    <option value="">לא נקבע</option>
                    <option value="north">צפון</option>
                    <option value="sharon">השרון</option>
                    <option value="center">מרכז</option>
                    <option value="jerusalem">ירושלים והסביבה</option>
                    <option value="south">דרום</option>
                </select>
            </div>
            
            <!-- Style -->
            <div>
                <label class="block text-sm font-bold text-gray-600 mb-2 uppercase tracking-widest">סגנון</label>
                <select id="editStyle" class="w-full p-4 border border-gray-200 outline-none focus:border-[color:var(--color-espresso)] bg-white">
                    <option value="">לא נקבע</option>
                    <option value="classic">קלאסי</option>
                    <option value="modern">מודרני</option>
                    <option value="rustic">כפרי</option>
                    <option value="bohemian">בוהו</option>
                    <option value="luxurious">יוקרתי</option>
                </select>
            </div>
            
            <!-- Status -->
            <div>
                <label class="block text-sm font-bold text-gray-600 mb-2 uppercase tracking-widest">סטטוס</label>
                <select id="editStatus" class="w-full p-4 border border-gray-200 outline-none focus:border-[color:var(--color-espresso)] bg-white">
                    <option value="תכנון">תכנון</option>
                    <option value="בתהליך">בתהליך</option>
                    <option value="הושלם">הושלם</option>
                    <option value="בוטל">בוטל</option>
                </select>
            </div>
            
            <!-- Buttons -->
            <div class="flex gap-4 pt-4">
                <button type="button" onclick="closeEditModal()" class="flex-1 py-4 border border-gray-200 text-gray-500 hover:bg-gray-50 transition-colors uppercase tracking-widest text-sm">ביטול</button>
                <button type="submit" class="flex-1 py-4 bg-[color:var(--color-espresso)] text-white hover:opacity-90 transition-opacity uppercase tracking-widest text-sm">שמור שינויים</button>
            </div>
        </form>
    </div>
</div>

<script>
    const eventId = {{ event.id }};
    
    // Current event data
    const currentEvent = {
        event_type: '{{ event.event_type }}',
        date: '{{ event.date or "" }}',
        time_of_day: '{{ event.time_of_day or "" }}',
        guests: '{{ event.guests or "" }}',
        budget: '{{ event.budget or "" }}',
        region: '{{ event.region or "" }}',
        style: '{{ event.style or "" }}',
        status: '{{ event.status or "תכנון" }}'
    };

    // Edit Event Modal Functions
    function openEditModal() {
        document.getElementById('editEventModal').classList.remove('hidden');
        document.getElementById('editEventModal').classList.add('flex');
        
        // Populate form with current values
        document.getElementById('editEventType').value = currentEvent.event_type;
        document.getElementById('editDate').value = currentEvent.date;
        document.getElementById('editTimeOfDay').value = currentEvent.time_of_day;
        document.getElementById('editGuests').value = currentEvent.guests;
        document.getElementById('editBudget').value = currentEvent.budget;
        document.getElementById('editRegion').value = currentEvent.region;
        document.getElementById('editStyle').value = currentEvent.style;
        document.getElementById('editStatus').value = currentEvent.status;
    }

    function closeEditModal() {
        document.getElementById('editEventModal').classList.add('hidden');
        document.getElementById('editEventModal').classList.remove('flex');
    }

    // Handle edit form submission
    document.getElementById('editEventForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const updatedData = {
            event_type: document.getElementById('editEventType').value,
            date: document.getElementById('editDate').value,
            time_of_day: document.getElementById('editTimeOfDay').value,
            guests: document.getElementById('editGuests').value,
            budget: document.getElementById('editBudget').value,
            region: document.getElementById('editRegion').value,
            style: document.getElementById('editStyle').value,
            status: document.getElementById('editStatus').value
        };
        
        try {
            const response = await fetch(`/api/event/${eventId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData)
            });
            
            if (response.ok) {
                location.reload();
            } else {
                alert('שגיאה בעדכון האירוע');
            }
        } catch (error) {
            console.error('Error updating event:', error);
            alert('שגיאה בעדכון האירוע');
        }
    });

    // Delete Event
    async function confirmDeleteEvent() {
        if (!confirm('האם אתה בטוח שברצונך למחוק את האירוע? פעולה זו לא ניתנת לביטול.')) return;
        
        try {
            const response = await fetch(`/api/event/${eventId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                window.location.href = '/dashboard';
            } else {
                alert('שגיאה במחיקת האירוע');
            }
        } catch (error) {
            console.error('Error deleting event:', error);
            alert('שגיאה במחיקת האירוע');
        }
    }

    function openAddItemModal() {
        document.getElementById('addItemModal').classList.remove('hidden');
        document.getElementById('addItemModal').classList.add('flex');
        document.getElementById('newItemTitle').focus();
    }

    function closeAddItemModal() {
        document.getElementById('addItemModal').classList.add('hidden');
        document.getElementById('addItemModal').classList.remove('flex');
        document.getElementById('newItemTitle').value = '';
    }

    async function addItem() {
        const title = document.getElementById('newItemTitle').value;
        if (!title) return;

        try {
            const response = await fetch(`/api/event/${eventId}/checklist`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: title })
            });

            if (response.ok) {
                location.reload();
            }
        } catch (error) {
            console.error('Error adding item:', error);
        }
    }

    async function toggleItem(itemId, isCompleted) {
        try {
            await fetch(`/api/checklist/${itemId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_completed: isCompleted })
            });
            // Optional: Update progress bar without reload
            location.reload();
        } catch (error) {
            console.error('Error toggling item:', error);
        }
    }

    async function deleteItem(itemId) {
        if (!confirm('האם למחוק את המשימה?')) return;

        try {
            const response = await fetch(`/api/checklist/${itemId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                document.getElementById(`item-${itemId}`).remove();
                location.reload();
            }
        } catch (error) {
            console.error('Error deleting item:', error);
        }
    }

    // Vendor List Display
    function showVendorsList() {
        alert('רשימת הספקים מוצגת בצד ימין של הדף');
        // Scroll to vendors section
        const vendorsSection = document.querySelector('.bg-white.p-8.shadow-sm.border.border-gray-100:last-of-type');
        if (vendorsSection) {
            vendorsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            vendorsSection.classList.add('ring-4', 'ring-[color:var(--color-caramel)]', 'ring-opacity-50');
            setTimeout(() => {
                vendorsSection.classList.remove('ring-4', 'ring-[color:var(--color-caramel)]', 'ring-opacity-50');
            }, 2000);
        }
    }
</script>
{% endblock %}
