{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-[#f4f1ea] py-20 relative">
    
    <!-- Floating Cart Button -->
    <div id="cart-btn" class="fixed bottom-8 left-8 z-50 bg-[color:var(--color-black)] text-white p-4 rounded-full shadow-2xl cursor-pointer hover:scale-110 transition-transform" onclick="toggleCart()">
        <div class="relative">
            <span class="text-2xl">ğŸ›’</span>
            <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full">0</span>
        </div>
    </div>

    <!-- Cart Sidebar (Hidden by default) -->
    <div id="cart-sidebar" class="fixed inset-y-0 left-0 w-80 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 z-50 p-6 overflow-y-auto">
        <div class="flex justify-between items-center mb-8 border-b pb-4">
            <h3 class="font-serif text-2xl">×”×¡×œ ×©×œ×™</h3>
            <button onclick="toggleCart()" class="text-2xl">&times;</button>
        </div>
        <div id="cart-items" class="space-y-4">
            <!-- Cart items will be injected here -->
            <p class="text-gray-400 text-center">×”×¡×œ ×¨×™×§</p>
        </div>
        <div class="mt-8 pt-4 border-t">
            <button onclick="clearCart()" class="w-full py-3 bg-red-50 text-red-500 hover:bg-red-100 transition-colors text-sm font-bold uppercase tracking-widest mb-4">
                ×¨×•×§×Ÿ ×¡×œ
            </button>
            <button onclick="saveEvent()" class="w-full py-4 bg-[color:var(--color-black)] text-white hover:bg-gray-800 transition-colors text-sm font-bold uppercase tracking-widest">
                ×©××•×¨ ××™×¨×•×¢
            </button>
        </div>
    </div>

    <div class="container px-4 md:px-8 mt-0">
        <!-- Header -->
        <div class="text-center mb-0 fade-in-up">
            <h2 class="font-serif text-3xl md:text-4xl mb-2 text-[color:var(--color-black)]">×”×‘×—×™×¨×•×ª ×©×œ×š</h2>
            <p class="font-sans text-gray-500 text-xs tracking-widest uppercase">×‘×—×¨ ××ª ×”×¡×¤×§×™× ×”××•×©×œ××™× ×œ××™×¨×•×¢ ×©×œ×š</p>
        </div>

        <!-- Premium Category Navigation -->
        <div class="sticky top-[54px] z-40 bg-gradient-to-b from-[#f4f1ea] to-[#f4f1ea]/95 backdrop-blur-md py-2 mb-12 border-b border-gray-200/50 shadow-sm -mx-4 md:-mx-8 px-4 md:px-8">
            <div class="flex justify-center items-center gap-2 flex-wrap px-4 max-w-full overflow-x-auto pb-1">
                {% for category, items in results.items() %}
                    {% if items %}
                    <a href="#{{ category }}" 
                       class="category-btn px-6 py-2 bg-white border-2 border-gray-300 rounded-full text-[color:var(--color-espresso)] font-bold text-xs uppercase tracking-wide whitespace-nowrap transition-all duration-250 ease-out hover:scale-108 hover:shadow-md hover:border-[color:var(--color-caramel)] hover:bg-[#faf7f2] hover:text-[color:var(--color-caramel)] active-category:bg-[color:var(--color-espresso)] active-category:text-white active-category:border-[color:var(--color-espresso)] active-category:shadow-md"
                       onclick="updateActiveCategory(this)">
                        {{ category }}
                    </a>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        <!-- Results Sections -->
        <div class="space-y-20">
            {% for category, items in results.items() %}
                {% if items %}
                <section id="{{ category }}" class="scroll-mt-24 fade-in-up">
                    <div class="flex items-center mb-10">
                        <h3 class="font-serif text-3xl text-[color:var(--color-black)] ml-6">{{ category }}</h3>
                        <div class="h-px bg-gray-200 flex-grow"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
                        {% for item in items %}
                        <div class="group bg-white transition-all duration-500 hover:shadow-xl border border-gray-50">
                            <div class="relative h-72 overflow-hidden">
                                <img src="{{ item.image }}" alt="{{ item.name }}" class="w-full h-full object-cover transition-transform duration-1000 group-hover:scale-105">
                                <div class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm px-3 py-1 text-[10px] font-bold uppercase tracking-widest text-[color:var(--color-black)]">
                                    {{ item.category }}
                                </div>
                            </div>
                            <div class="p-8 text-center">
                                <h4 class="font-serif text-2xl mb-2 text-[color:var(--color-black)]">{{ item.name }}</h4>
                                <p class="text-gray-400 mb-6 text-sm font-sans leading-relaxed">{{ item.description }}</p>
                                <div class="border-t border-gray-100 pt-6">
                                    <span class="block text-[color:var(--color-black)] font-bold text-lg mb-4">{{ item.price }} â‚ª</span>
                                    <button onclick="addToCart('{{ item.id }}', '{{ item.type }}', '{{ item.name }}', '{{ item.price }}')" 
                                            class="w-full py-3 border border-[color:var(--color-black)] text-[color:var(--color-black)] hover:bg-[color:var(--color-black)] hover:text-white transition-colors text-[10px] uppercase tracking-[0.2em] font-bold">
                                        ×”×•×¡×£ ×œ×¡×œ
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </section>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>

<script>
    // Cart Logic
    let cart = [];

    function toggleCart() {
        const sidebar = document.getElementById('cart-sidebar');
        if (sidebar.classList.contains('-translate-x-full')) {
            sidebar.classList.remove('-translate-x-full');
        } else {
            sidebar.classList.add('-translate-x-full');
        }
    }

    function updateCartUI() {
        const container = document.getElementById('cart-items');
        const countBadge = document.getElementById('cart-count');
        
        countBadge.innerText = cart.length;
        
        if (cart.length === 0) {
            container.innerHTML = '<p class="text-gray-400 text-center">×”×¡×œ ×¨×™×§</p>';
            return;
        }

        let html = '';
        let total = 0;
        cart.forEach(item => {
            total += parseInt(item.price);
            html += `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded">
                    <div>
                        <p class="font-bold text-sm">${item.name}</p>
                        <p class="text-xs text-gray-500">${item.price} â‚ª</p>
                    </div>
                </div>
            `;
        });
        
        html += `
            <div class="mt-4 pt-4 border-t border-gray-200 flex justify-between font-bold">
                <span>×¡×”"×›:</span>
                <span>${total} â‚ª</span>
            </div>
        `;
        
        container.innerHTML = html;
    }

    function addToCart(id, type, name, price) {
        fetch('/api/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ id, type, name, price }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Optimistic update or fetch fresh cart
                fetchCart();
                // Show toast or feedback
                const btn = event.target;
                const originalText = btn.innerText;
                btn.innerText = "× ×•×¡×£ âœ“";
                btn.classList.add('bg-green-600', 'text-white', 'border-green-600');
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.classList.remove('bg-green-600', 'text-white', 'border-green-600');
                }, 2000);
            } else {
                alert(data.message);
            }
        });
    }

    function fetchCart() {
        fetch('/api/cart')
        .then(res => res.json())
        .then(data => {
            cart = data.cart;
            updateCartUI();
        });
    }

    function clearCart() {
        fetch('/api/cart/clear', { method: 'POST' })
        .then(() => {
            cart = [];
            updateCartUI();
        });
    }

    async function saveEvent() {
        // Check if user is logged in
        const authResponse = await fetch('/api/current_user');
        const authData = await authResponse.json();
        
        if (!authData.authenticated) {
            alert('×× × ×”×ª×—×‘×¨ ×ª×—×™×œ×” ×›×“×™ ×œ×©××•×¨ ××™×¨×•×¢');
            window.location.href = '/login';
            return;
        }
        
        // Check if cart is not empty
        if (cart.length === 0) {
            alert('×× × ×‘×—×¨ ×œ×¤×—×•×ª ×¡×¤×§ ××—×“');
            return;
        }
        
        try {
            const response = await fetch('/api/save_event', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ event_type: 'other' })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert(data.message);
                window.location.href = data.redirect;
            } else {
                alert(data.message);
            }
        } catch (error) {
            console.error('Error saving event:', error);
            alert('×©×’×™××” ×‘×©××™×¨×ª ×”××™×¨×•×¢');
        }
    }

    // Active category management
    function updateActiveCategory(clickedBtn) {
        // Remove active state from all buttons
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.remove('active-category');
        });
        // Add active state to clicked button
        clickedBtn.classList.add('active-category');
    }

    // Set first category as active on page load
    document.addEventListener('DOMContentLoaded', function() {
        fetchCart();
        const firstBtn = document.querySelector('.category-btn');
        if (firstBtn) {
            firstBtn.classList.add('active-category');
        }
    });
</script>
{% endblock %}