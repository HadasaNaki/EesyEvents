{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-[#f4f1ea] py-20 relative">
    
    <!-- Floating Cart Button -->
    <div id="cart-btn" class="fixed bottom-8 left-8 z-50 bg-[color:var(--color-black)] text-white p-4 rounded-full shadow-2xl cursor-pointer hover:scale-110 transition-transform" onclick="toggleCart()">
        <div class="relative">
            <span class="text-2xl">ğŸ›’</span>
            <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full">0</span>
        </div>
    </div>

    <!-- Cart Sidebar (Hidden by default) -->
    <div id="cart-sidebar" class="fixed inset-y-0 left-0 w-80 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 z-50 p-6 overflow-y-auto">
        <div class="flex justify-between items-center mb-8 border-b pb-4">
            <h3 class="font-serif text-2xl">×”×¡×œ ×©×œ×™</h3>
            <button onclick="toggleCart()" class="text-2xl">&times;</button>
        </div>
        <div id="cart-items" class="space-y-4">
            <!-- Cart items will be injected here -->
            <p class="text-gray-400 text-center">×”×¡×œ ×¨×™×§</p>
        </div>
        <div class="mt-8 pt-4 border-t">
            <button onclick="clearCart()" class="w-full py-3 bg-red-50 text-red-500 hover:bg-red-100 transition-colors text-sm font-bold uppercase tracking-widest mb-4">
                ×¨×•×§×Ÿ ×¡×œ
            </button>
            <button onclick="saveEvent()" class="w-full py-4 bg-[color:var(--color-black)] text-white hover:bg-gray-800 transition-colors text-sm font-bold uppercase tracking-widest">
                ×©××•×¨ ××™×¨×•×¢
            </button>
        </div>
    </div>

    <div class="container px-4 md:px-8 mt-0">
        <!-- Header -->
        <div class="text-center mb-8 fade-in-up">
            <h2 class="font-serif text-3xl md:text-4xl mb-2 text-[color:var(--color-black)]">×”×‘×—×™×¨×•×ª ×©×œ×š</h2>
            <p class="font-sans text-gray-500 text-xs tracking-widest uppercase">×‘×—×¨ ××ª ×”×¡×¤×§×™× ×”××•×©×œ××™× ×œ××™×¨×•×¢ ×©×œ×š</p>
        </div>

        <!-- Advanced Filters -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8 fade-in-up">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Search -->
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-2 uppercase tracking-wide">×—×™×¤×•×©</label>
                    <input type="text" id="searchInput" placeholder="×—×¤×© ×¡×¤×§..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-[color:var(--color-black)] outline-none text-sm"
                           oninput="applyFilters()">
                </div>

                <!-- City Filter -->
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-2 uppercase tracking-wide">×¢×™×¨</label>
                    <select id="cityFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-[color:var(--color-black)] outline-none text-sm" onchange="applyFilters()">
                        <option value="">×›×œ ×”×¢×¨×™×</option>
                    </select>
                </div>

                <!-- Price Range -->
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-2 uppercase tracking-wide">
                        <span>×˜×•×•×— ××—×™×¨×™×</span>
                        <span id="priceRangeDisplay" class="font-normal text-gray-400 mr-2"></span>
                    </label>
                    <input type="range" id="priceRange" min="0" max="10000" value="10000" step="500"
                           class="w-full" oninput="updatePriceDisplay(); applyFilters()">
                </div>

                <!-- Sort By -->
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-2 uppercase tracking-wide">××™×•×Ÿ</label>
                    <select id="sortBy" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-[color:var(--color-black)] outline-none text-sm" onchange="applyFilters()">
                        <option value="name-asc">×©× (×-×ª)</option>
                        <option value="name-desc">×©× (×ª-×)</option>
                        <option value="price-asc">××—×™×¨ (× ××•×š ×œ×’×‘×•×”)</option>
                        <option value="price-desc">××—×™×¨ (×’×‘×•×” ×œ× ××•×š)</option>
                    </select>
                </div>
            </div>

            <!-- Active Filters Display -->
            <div id="activeFilters" class="mt-4 flex gap-2 flex-wrap hidden">
                <!-- Filter tags will appear here -->
            </div>

            <!-- Reset Filters -->
            <button onclick="resetFilters()" class="mt-4 text-xs text-gray-500 hover:text-[color:var(--color-black)] uppercase tracking-wide font-bold">
                ××¤×¡ ×¡×™× ×•×Ÿ
            </button>
        </div>

        <!-- Premium Category Navigation -->
        <div class="sticky top-[54px] z-40 bg-gradient-to-b from-[#f4f1ea] to-[#f4f1ea]/95 backdrop-blur-md py-2 mb-12 border-b border-gray-200/50 shadow-sm -mx-4 md:-mx-8 px-4 md:px-8">
            <div class="flex justify-center items-center gap-2 flex-wrap px-4 max-w-full overflow-x-auto pb-1">
                {% for category, items in results.items() %}
                    {% if items %}
                    <a href="#{{ category }}" 
                       class="category-btn px-6 py-2 bg-white border-2 border-gray-300 rounded-full text-[color:var(--color-espresso)] font-bold text-xs uppercase tracking-wide whitespace-nowrap transition-all duration-250 ease-out hover:scale-108 hover:shadow-md hover:border-[color:var(--color-caramel)] hover:bg-[#faf7f2] hover:text-[color:var(--color-caramel)] active-category:bg-[color:var(--color-espresso)] active-category:text-white active-category:border-[color:var(--color-espresso)] active-category:shadow-md"
                       onclick="updateActiveCategory(this)">
                        {{ category }}
                    </a>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        <!-- Results Sections -->
        <div class="space-y-20">
            {% for category, items in results.items() %}
                {% if items %}
                <section id="{{ category }}" class="scroll-mt-24 fade-in-up">
                    <div class="flex items-center mb-10">
                        <h3 class="font-serif text-3xl text-[color:var(--color-black)] ml-6">{{ category }}</h3>
                        <div class="h-px bg-gray-200 flex-grow"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
                        {% for item in items %}
                        <div class="group bg-white transition-all duration-500 hover:shadow-xl border border-gray-50"
                             data-item='{"name":"{{ item.name }}", "price":{{ item.price }}, "description":"{{ item.description }}", "category":"{{ category }}"}'>
                            <div class="relative h-72 overflow-hidden">
                                <img src="{{ item.image }}" alt="{{ item.name }}" class="w-full h-full object-cover transition-transform duration-1000 group-hover:scale-105">
                                <div class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm px-3 py-1 text-[10px] font-bold uppercase tracking-widest text-[color:var(--color-black)]">
                                    {{ item.category }}
                                </div>
                            </div>
                            <div class="p-8 text-center">
                                <h4 class="font-serif text-2xl mb-2 text-[color:var(--color-black)]">{{ item.name }}</h4>
                                <p class="text-gray-400 mb-6 text-sm font-sans leading-relaxed">{{ item.description }}</p>
                                <div class="border-t border-gray-100 pt-6">
                                    <span class="block text-[color:var(--color-black)] font-bold text-lg mb-4">{{ item.price }} â‚ª</span>
                                    <button data-id="{{ item.id }}" 
                                            data-type="{{ item.type }}" 
                                            data-name="{{ item.name }}" 
                                            data-price="{{ item.price }}"
                                            onclick="addToCart(this.dataset.id, this.dataset.type, this.dataset.name, this.dataset.price, this)" 
                                            class="add-to-cart-btn w-full py-3 border border-[color:var(--color-black)] text-[color:var(--color-black)] hover:bg-[color:var(--color-black)] hover:text-white transition-colors text-[10px] uppercase tracking-[0.2em] font-bold">
                                        ×”×•×¡×£ ×œ×¡×œ
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </section>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>

<script>
    // Cart Logic
    let cart = [];
    let allItems = []; // Store all items for filtering

    // Initialize filters on page load
    document.addEventListener('DOMContentLoaded', function() {
        fetchCart();
        const firstBtn = document.querySelector('.category-btn');
        if (firstBtn) {
            firstBtn.classList.add('active-category');
        }
        
        // Collect all items and populate filters
        initializeFilters();
        updatePriceDisplay();
    });

    function initializeFilters() {
        // Collect all items from the page
        const itemCards = document.querySelectorAll('[data-item]');
        const cities = new Set();
        
        itemCards.forEach(card => {
            const itemData = JSON.parse(card.getAttribute('data-item'));
            allItems.push({
                element: card.closest('.group'),
                ...itemData
            });
            
            // Extract city from description
            const cityMatch = itemData.description.match(/^([^,\.]+)/);
            if (cityMatch) {
                cities.add(cityMatch[1].trim());
            }
        });
        
        // Populate city filter
        const cityFilter = document.getElementById('cityFilter');
        Array.from(cities).sort().forEach(city => {
            const option = document.createElement('option');
            option.value = city;
            option.textContent = city;
            cityFilter.appendChild(option);
        });
    }

    function updatePriceDisplay() {
        const priceRange = document.getElementById('priceRange');
        const display = document.getElementById('priceRangeDisplay');
        display.textContent = `×¢×“ ${parseInt(priceRange.value).toLocaleString()} â‚ª`;
    }

    function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const selectedCity = document.getElementById('cityFilter').value;
        const maxPrice = parseInt(document.getElementById('priceRange').value);
        const sortBy = document.getElementById('sortBy').value;
        
        // Filter items
        let filteredItems = allItems.filter(item => {
            // Search filter
            if (searchTerm && !item.name.toLowerCase().includes(searchTerm)) {
                return false;
            }
            
            // City filter
            if (selectedCity && !item.description.includes(selectedCity)) {
                return false;
            }
            
            // Price filter
            if (item.price > maxPrice) {
                return false;
            }
            
            return true;
        });
        
        // Sort items
        filteredItems.sort((a, b) => {
            switch(sortBy) {
                case 'name-asc':
                    return a.name.localeCompare(b.name, 'he');
                case 'name-desc':
                    return b.name.localeCompare(a.name, 'he');
                case 'price-asc':
                    return a.price - b.price;
                case 'price-desc':
                    return b.price - a.price;
                default:
                    return 0;
            }
        });
        
        // Hide all items first
        allItems.forEach(item => {
            item.element.style.display = 'none';
        });
        
        // Show filtered and sorted items
        filteredItems.forEach((item, index) => {
            item.element.style.display = 'block';
            item.element.style.order = index;
        });
        
        // Update active filters display
        updateActiveFiltersDisplay(searchTerm, selectedCity, maxPrice);
        
        // Hide empty sections
        updateSectionVisibility();
        
        // Show results count
        showResultsCount(filteredItems.length, allItems.length);
    }

    function updateActiveFiltersDisplay(search, city, price) {
        const container = document.getElementById('activeFilters');
        let html = '';
        
        if (search) {
            html += `<span class="bg-[color:var(--color-black)] text-white px-3 py-1 rounded-full text-xs">×—×™×¤×•×©: ${search}</span>`;
        }
        if (city) {
            html += `<span class="bg-[color:var(--color-black)] text-white px-3 py-1 rounded-full text-xs">×¢×™×¨: ${city}</span>`;
        }
        if (price < 10000) {
            html += `<span class="bg-[color:var(--color-black)] text-white px-3 py-1 rounded-full text-xs">×¢×“ ${price.toLocaleString()} â‚ª</span>`;
        }
        
        if (html) {
            container.innerHTML = html;
            container.classList.remove('hidden');
        } else {
            container.classList.add('hidden');
        }
    }

    function updateSectionVisibility() {
        document.querySelectorAll('section[id]').forEach(section => {
            const visibleItems = section.querySelectorAll('.group[style*="display: block"]').length;
            if (visibleItems === 0) {
                section.style.display = 'none';
            } else {
                section.style.display = 'block';
            }
        });
    }

    function showResultsCount(filtered, total) {
        // Remove existing count if any
        const existingCount = document.getElementById('results-count');
        if (existingCount) existingCount.remove();
        
        // Add count below filters
        const filtersDiv = document.querySelector('.bg-white.rounded-lg.shadow-md');
        const countDiv = document.createElement('div');
        countDiv.id = 'results-count';
        countDiv.className = 'text-center text-sm text-gray-600 mt-4 font-sans';
        countDiv.innerHTML = `××¦×™×’ <strong>${filtered}</strong> ××ª×•×š <strong>${total}</strong> ×ª×•×¦××•×ª`;
        filtersDiv.appendChild(countDiv);
    }

    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('cityFilter').value = '';
        document.getElementById('priceRange').value = 10000;
        document.getElementById('sortBy').value = 'name-asc';
        updatePriceDisplay();
        
        // Show all items
        allItems.forEach(item => {
            item.element.style.display = 'block';
        });
        
        // Hide active filters
        document.getElementById('activeFilters').classList.add('hidden');
        
        // Show all sections
        document.querySelectorAll('section[id]').forEach(section => {
            section.style.display = 'block';
        });
        
        // Remove count
        const countDiv = document.getElementById('results-count');
        if (countDiv) countDiv.remove();
    }

    function toggleCart() {
        const sidebar = document.getElementById('cart-sidebar');
        if (sidebar.classList.contains('-translate-x-full')) {
            sidebar.classList.remove('-translate-x-full');
        } else {
            sidebar.classList.add('-translate-x-full');
        }
    }

    function updateCartUI() {
        console.log('ğŸ”µ Updating cart UI, cart items:', cart);
        
        const container = document.getElementById('cart-items');
        const countBadge = document.getElementById('cart-count');
        
        countBadge.innerText = cart.length;
        
        if (cart.length === 0) {
            container.innerHTML = '<p class="text-gray-400 text-center">×”×¡×œ ×¨×™×§</p>';
            return;
        }

        let html = '';
        let total = 0;
        cart.forEach(item => {
            total += parseInt(item.price);
            html += `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded">
                    <div>
                        <p class="font-bold text-sm">${item.name}</p>
                        <p class="text-xs text-gray-500">${item.price} â‚ª</p>
                    </div>
                </div>
            `;
        });
        
        html += `
            <div class="mt-4 pt-4 border-t border-gray-200 flex justify-between font-bold">
                <span>×¡×”"×›:</span>
                <span>${total} â‚ª</span>
            </div>
        `;
        
        console.log('ğŸ”µ Cart HTML generated, total:', total);
        container.innerHTML = html;
    }

    function addToCart(id, type, name, price, btnElement) {
        console.log('ğŸ”µ Adding to cart:', {id, type, name, price});
        
        fetch('/api/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ id, type, name, price }),
        })
        .then(response => response.json())
        .then(data => {
            console.log('ğŸ”µ Server response:', data);
            
            if (data.success) {
                // Fetch fresh cart
                fetchCart();
                
                // Show visual feedback on button
                if (btnElement) {
                    const originalText = btnElement.innerText;
                    btnElement.innerText = "× ×•×¡×£ âœ“";
                    btnElement.classList.add('bg-green-600', 'text-white', 'border-green-600');
                    setTimeout(() => {
                        btnElement.innerText = originalText;
                        btnElement.classList.remove('bg-green-600', 'text-white', 'border-green-600');
                    }, 2000);
                }
            } else {
                console.warn('âš ï¸ Item not added:', data.message);
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('âŒ Error adding to cart:', error);
            alert('×©×’×™××” ×‘×”×•×¡×¤×” ×œ×¡×œ');
        });
    }

    function fetchCart() {
        console.log('ğŸ”µ Fetching cart from server...');
        fetch('/api/cart')
        .then(res => res.json())
        .then(data => {
            console.log('ğŸ”µ Cart received:', data);
            cart = data.cart || [];
            console.log('ğŸ”µ Cart items:', cart);
            updateCartUI();
        })
        .catch(error => {
            console.error('âŒ Error fetching cart:', error);
        });
    }

    function clearCart() {
        fetch('/api/cart/clear', { method: 'POST' })
        .then(() => {
            cart = [];
            updateCartUI();
        });
    }

    async function saveEvent() {
        console.log('ğŸ”µ saveEvent called, cart:', cart);
        
        // Check if user is logged in
        const authResponse = await fetch('/api/current_user');
        const authData = await authResponse.json();
        console.log('ğŸ”µ Auth data:', authData);
        
        if (!authData.authenticated) {
            alert('×× × ×”×ª×—×‘×¨ ×ª×—×™×œ×” ×›×“×™ ×œ×©××•×¨ ××™×¨×•×¢');
            window.location.href = '/login';
            return;
        }
        
        // Check if cart is not empty
        if (cart.length === 0) {
            alert('×× × ×‘×—×¨ ×œ×¤×—×•×ª ×¡×¤×§ ××—×“');
            return;
        }
        
        console.log('ğŸ”µ Sending cart to server:', cart);
        
        try {
            // Save the event with all cart items
            const response = await fetch('/api/save_cart_to_event', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    cart_items: cart 
                })
            });
            
            const data = await response.json();
            console.log('ğŸ”µ Server response:', data);
            
            if (data.success) {
                // Clear cart after successful save
                await fetch('/api/cart/clear', { method: 'POST' });
                cart = [];
                updateCartUI();
                
                alert(data.message);
                window.location.href = data.redirect || '/dashboard';
            } else {
                alert(data.message);
            }
        } catch (error) {
            console.error('âŒ Error saving event:', error);
            alert('×©×’×™××” ×‘×©××™×¨×ª ×”××™×¨×•×¢');
        }
    }

    // Active category management
    function updateActiveCategory(clickedBtn) {
        // Remove active state from all buttons
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.remove('active-category');
        });
        // Add active state to clicked button
        clickedBtn.classList.add('active-category');
    }
</script>
{% endblock %}