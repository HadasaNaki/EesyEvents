{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-[#f4f1ea] py-20 relative">
    
    <!-- Floating Cart Button -->
    <div id="cart-btn" class="fixed bottom-8 left-8 z-50 bg-[color:var(--color-black)] text-white p-4 rounded-full shadow-2xl cursor-pointer hover:scale-110 transition-transform" onclick="toggleCart()">
        <div class="relative">
            <span class="text-2xl">ğŸ›’</span>
            <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full">0</span>
        </div>
    </div>

    <!-- Cart Sidebar (Hidden by default) -->
    <div id="cart-sidebar" class="fixed inset-y-0 left-0 w-80 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 z-50 p-6 overflow-y-auto">
        <div class="flex justify-between items-center mb-8 border-b pb-4">
            <h3 class="font-serif text-2xl">×”×¡×œ ×©×œ×™</h3>
            <button onclick="toggleCart()" class="text-2xl">&times;</button>
        </div>
        <div id="cart-items" class="space-y-4">
            <!-- Cart items will be injected here -->
            <p class="text-gray-400 text-center">×”×¡×œ ×¨×™×§</p>
        </div>
        <div class="mt-8 pt-4 border-t">
            <button onclick="clearCart()" class="w-full py-3 bg-red-50 text-red-500 hover:bg-red-100 transition-colors text-sm font-bold uppercase tracking-widest mb-4">
                ×¨×•×§×Ÿ ×¡×œ
            </button>
            <button onclick="saveEvent()" class="w-full py-4 bg-[color:var(--color-black)] text-white hover:bg-gray-800 transition-colors text-sm font-bold uppercase tracking-widest">
                ×©××•×¨ ××™×¨×•×¢
            </button>
        </div>
    </div>

    <div class="container px-4 md:px-8 mt-0">
        <!-- Header -->
        <div class="text-center mb-8 fade-in-up">
            <h2 class="font-serif text-3xl md:text-4xl mb-2 text-[color:var(--color-black)]">×”×‘×—×™×¨×•×ª ×©×œ×š</h2>
            <p class="font-sans text-gray-500 text-xs tracking-widest uppercase">×‘×—×¨ ××ª ×”×¡×¤×§×™× ×”××•×©×œ××™× ×œ××™×¨×•×¢ ×©×œ×š</p>
        </div>

        <!-- Advanced Filters - Professional Edition -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-8 fade-in-up border border-gray-100">
            <!-- Filter Header -->
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-100">
                <div>
                    <h3 class="font-serif text-xl text-[color:var(--color-espresso)]">×¡×™× ×•×Ÿ ××ª×§×“×</h3>
                    <p class="text-xs text-gray-400 mt-1">××¦× ××ª ×”×¡×¤×§×™× ×”××•×©×œ××™× ×‘×§×œ×•×ª</p>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="toggleCompareMode()" id="compareBtn" 
                            class="px-4 py-2 border border-gray-300 rounded-lg text-xs font-bold uppercase tracking-wide hover:bg-gray-50 transition-colors">
                        <span class="hidden" id="compareIcon">âš–ï¸</span> ×”×©×•×•××”
                    </button>
                    <button onclick="resetFilters()" 
                            class="px-4 py-2 bg-red-50 text-red-600 rounded-lg text-xs font-bold uppercase tracking-wide hover:bg-red-100 transition-colors">
                        × ×§×” ×”×›×œ
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Smart Search with Autocomplete -->
                <div class="relative">
                    <label class="block text-xs font-bold text-gray-700 mb-2 uppercase tracking-wide">
                        ğŸ” ×—×™×¤×•×© ×—×›×
                    </label>
                    <input type="text" id="searchInput" placeholder="×”×§×œ×“ ×œ×—×™×¤×•×©..." 
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-[color:var(--color-espresso)] focus:ring-2 focus:ring-[color:var(--color-caramel)]/20 outline-none text-sm transition-all"
                           oninput="handleSmartSearch(this.value)" autocomplete="off">
                    <div id="searchSuggestions" class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden"></div>
                </div>

                <!-- Multi-Select Category Filter -->
                <div>
                    <label class="block text-xs font-bold text-gray-700 mb-2 uppercase tracking-wide">
                        ğŸ“‚ ×§×˜×’×•×¨×™×•×ª
                    </label>
                    <div class="relative">
                        <button onclick="toggleCategoryDropdown()" 
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg text-sm text-right hover:border-[color:var(--color-espresso)] transition-all flex justify-between items-center">
                            <span id="categorySelectedText" class="text-gray-500">×‘×—×¨ ×§×˜×’×•×¨×™×•×ª...</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="categoryDropdown" class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg p-3 z-50 hidden max-h-60 overflow-y-auto">
                            <!-- Categories will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- City Multi-Select -->
                <div>
                    <label class="block text-xs font-bold text-gray-700 mb-2 uppercase tracking-wide">
                        ğŸ“ ×¢×¨×™×
                    </label>
                    <div class="relative">
                        <button onclick="toggleCityDropdown()" 
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg text-sm text-right hover:border-[color:var(--color-espresso)] transition-all flex justify-between items-center">
                            <span id="citySelectedText" class="text-gray-500">×‘×—×¨ ×¢×¨×™×...</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="cityDropdown" class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg p-3 z-50 hidden max-h-60 overflow-y-auto">
                            <!-- Cities will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Price Range with Visual Feedback -->
                <div>
                    <label class="block text-xs font-bold text-gray-700 mb-2 uppercase tracking-wide">
                        ğŸ’° ×˜×•×•×— ××—×™×¨×™×
                        <span id="priceRangeDisplay" class="font-normal text-[color:var(--color-caramel)] mr-2"></span>
                    </label>
                    <div class="relative pt-1">
                        <input type="range" id="priceRange" min="0" max="20000" value="20000" step="500"
                               class="w-full h-2 bg-gradient-to-r from-green-200 via-yellow-200 to-red-200 rounded-lg appearance-none cursor-pointer accent-[color:var(--color-espresso)]" 
                               oninput="updatePriceDisplay(); applyFilters()">
                        <div class="flex justify-between text-xs text-gray-400 mt-1">
                            <span>0 â‚ª</span>
                            <span>20,000 â‚ª</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Second Row - Advanced Filters -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6 pt-6 border-t border-gray-100">
                <!-- Rating Filter -->
                <div>
                    <label class="block text-xs font-bold text-gray-700 mb-2 uppercase tracking-wide">
                        â­ ×“×™×¨×•×’ ××™× ×™××œ×™
                    </label>
                    <div class="flex gap-2">
                        <button onclick="setMinRating(0)" class="rating-btn px-3 py-2 border-2 border-gray-200 rounded-lg text-sm hover:border-[color:var(--color-caramel)] transition-all" data-rating="0">
                            ×”×›×œ
                        </button>
                        <button onclick="setMinRating(3)" class="rating-btn px-3 py-2 border-2 border-gray-200 rounded-lg text-sm hover:border-[color:var(--color-caramel)] transition-all" data-rating="3">
                            3+
                        </button>
                        <button onclick="setMinRating(4)" class="rating-btn px-3 py-2 border-2 border-gray-200 rounded-lg text-sm hover:border-[color:var(--color-caramel)] transition-all" data-rating="4">
                            4+
                        </button>
                        <button onclick="setMinRating(4.5)" class="rating-btn px-3 py-2 border-2 border-gray-200 rounded-lg text-sm hover:border-[color:var(--color-caramel)] transition-all" data-rating="4.5">
                            4.5+
                        </button>
                    </div>
                </div>

                <!-- Sort Options -->
                <div>
                    <label class="block text-xs font-bold text-gray-700 mb-2 uppercase tracking-wide">
                        ğŸ”„ ××™×•×Ÿ ×ª×•×¦××•×ª
                    </label>
                    <select id="sortBy" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-[color:var(--color-espresso)] outline-none text-sm transition-all" onchange="applyFilters()">
                        <option value="recommended">××•××œ×¥</option>
                        <option value="name-asc">×©× (×-×ª)</option>
                        <option value="name-desc">×©× (×ª-×)</option>
                        <option value="price-asc">××—×™×¨ (× ××•×š ×œ×’×‘×•×”)</option>
                        <option value="price-desc">××—×™×¨ (×’×‘×•×” ×œ× ××•×š)</option>
                        <option value="rating-desc">×“×™×¨×•×’ (×’×‘×•×” ×œ× ××•×š)</option>
                        <option value="popular">×”×›×™ ×¤×•×¤×•×œ×¨×™</option>
                    </select>
                </div>

                <!-- Results Counter -->
                <div>
                    <label class="block text-xs font-bold text-gray-700 mb-2 uppercase tracking-wide">
                        ğŸ“Š ×ª×•×¦××•×ª
                    </label>
                    <div class="px-4 py-3 bg-gradient-to-r from-[color:var(--color-espresso)] to-[color:var(--color-coffee)] text-white rounded-lg text-center">
                        <div class="text-2xl font-bold" id="resultsCount">0</div>
                        <div class="text-xs opacity-90">×¡×¤×§×™× × ××¦××•</div>
                    </div>
                </div>
            </div>

            <!-- Active Filters Tags -->
            <div id="activeFilters" class="mt-6 flex gap-2 flex-wrap hidden">
                <!-- Filter tags will appear here -->
            </div>
        </div>

        <!-- Premium Category Navigation -->
        <div class="sticky top-[54px] z-40 bg-gradient-to-b from-[#f4f1ea] to-[#f4f1ea]/95 backdrop-blur-md py-2 mb-12 border-b border-gray-200/50 shadow-sm -mx-4 md:-mx-8 px-4 md:px-8">
            <div class="flex justify-center items-center gap-2 flex-wrap px-4 max-w-full overflow-x-auto pb-1">
                {% for category, items in results.items() %}
                    {% if items %}
                    <a href="#{{ category }}" 
                       class="category-btn px-6 py-2 bg-white border-2 border-gray-300 rounded-full text-[color:var(--color-espresso)] font-bold text-xs uppercase tracking-wide whitespace-nowrap transition-all duration-250 ease-out hover:scale-108 hover:shadow-md hover:border-[color:var(--color-caramel)] hover:bg-[#faf7f2] hover:text-[color:var(--color-caramel)] active-category:bg-[color:var(--color-espresso)] active-category:text-white active-category:border-[color:var(--color-espresso)] active-category:shadow-md"
                       onclick="updateActiveCategory(this)">
                        {{ category }}
                    </a>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        <!-- Results Sections -->
        <div class="space-y-20">
            {% for category, items in results.items() %}
                {% if items %}
                <section id="{{ category }}" class="scroll-mt-24 fade-in-up">
                    <div class="flex items-center mb-10">
                        <h3 class="font-serif text-3xl text-[color:var(--color-black)] ml-6">{{ category }}</h3>
                        <div class="h-px bg-gray-200 flex-grow"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
                        {% for item in items %}
                        <div class="group bg-white rounded-xl transition-all duration-500 hover:shadow-2xl border-2 border-gray-100 hover:border-[color:var(--color-caramel)] overflow-hidden relative supplier-card"
                             data-id="{{ item.id }}"
                             data-type="{{ item.type }}"
                             data-name="{{ item.name }}"
                             data-price="{{ item.price }}"
                             data-category="{{ category }}"
                             data-rating="{{ (3.5 + (loop.index % 15) * 0.1) | round(1) }}"
                             data-item='{"name":"{{ item.name }}", "price":{{ item.price }}, "description":"{{ item.description }}", "category":"{{ category }}"}'>
                            
                            <!-- Compare Checkbox (hidden by default) -->
                            <div class="compare-checkbox hidden absolute top-4 left-4 z-10">
                                <input type="checkbox" 
                                       class="w-6 h-6 rounded border-2 border-white shadow-lg cursor-pointer accent-[color:var(--color-espresso)]"
                                       onchange="toggleCompareItem(this, '{{ item.id }}'')">
                            </div>

                            <!-- Favorite Heart Icon -->
                            <button class="absolute top-4 right-4 z-10 w-10 h-10 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center shadow-md hover:scale-110 transition-transform"
                                    onclick="toggleFavorite('{{ item.id }}', this)">
                                <svg class="w-5 h-5 text-gray-400 hover:text-red-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                </svg>
                            </button>

                            <div class="relative h-72 overflow-hidden">
                                <img src="{{ item.image }}" alt="{{ item.name }}" class="w-full h-full object-cover transition-transform duration-1000 group-hover:scale-110">
                                
                                <!-- Category Badge -->
                                <div class="absolute bottom-4 right-4 bg-gradient-to-r from-[color:var(--color-espresso)] to-[color:var(--color-coffee)] backdrop-blur-sm px-4 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest text-white shadow-lg">
                                    {{ item.category }}
                                </div>

                                <!-- Rating Badge -->
                                <div class="absolute top-4 left-4 bg-white/95 backdrop-blur-sm px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-1 shadow-md">
                                    <span class="text-yellow-500">â­</span>
                                    <span class="text-[color:var(--color-espresso)]">{{ (3.5 + (loop.index % 15) * 0.1) | round(1) }}</span>
                                </div>
                            </div>
                            
                            <div class="p-6">
                                <h4 class="font-serif text-2xl mb-2 text-[color:var(--color-espresso)] group-hover:text-[color:var(--color-caramel)] transition-colors">
                                    {{ item.name }}
                                </h4>
                                <p class="text-gray-500 mb-4 text-sm font-sans leading-relaxed h-12 overflow-hidden">
                                    {{ item.description }}
                                </p>

                                <!-- Quick Info Tags -->
                                <div class="flex flex-wrap gap-2 mb-4">
                                    <span class="px-3 py-1 bg-gray-100 rounded-full text-xs text-gray-600">
                                        ğŸ“ ×–××™×Ÿ
                                    </span>
                                    <span class="px-3 py-1 bg-green-50 rounded-full text-xs text-green-600">
                                        âœ“ ××•××œ×¥
                                    </span>
                                </div>

                                <div class="border-t border-gray-100 pt-4 space-y-3">
                                    <!-- Price -->
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-500 text-sm">××—×™×¨ ×-</span>
                                        <span class="text-[color:var(--color-espresso)] font-bold text-2xl">{{ item.price }} â‚ª</span>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="grid grid-cols-2 gap-2">
                                        <button onclick="viewDetails('{{ item.id }}', '{{ item.type }}')" 
                                                class="py-2.5 border-2 border-gray-200 text-gray-700 rounded-lg hover:border-[color:var(--color-espresso)] hover:bg-gray-50 transition-all text-xs font-bold uppercase tracking-wide">
                                            ×¤×¨×˜×™×
                                        </button>
                                        <button data-id="{{ item.id }}" 
                                                data-type="{{ item.type }}" 
                                                data-name="{{ item.name }}" 
                                                data-price="{{ item.price }}"
                                                onclick="addToCart(this.dataset.id, this.dataset.type, this.dataset.name, this.dataset.price, this)" 
                                                class="add-to-cart-btn py-2.5 bg-gradient-to-r from-[color:var(--color-espresso)] to-[color:var(--color-coffee)] text-white rounded-lg hover:shadow-lg hover:scale-105 transition-all text-xs font-bold uppercase tracking-wide">
                                            ×”×•×¡×£ ×œ×¡×œ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </section>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>

<script>
    // Cart Logic
    let cart = [];
    let allItems = []; // Store all items for filtering

    // Initialize filters on page load
    document.addEventListener('DOMContentLoaded', function() {
        fetchCart();
        const firstBtn = document.querySelector('.category-btn');
        if (firstBtn) {
            firstBtn.classList.add('active-category');
        }
        
        // Collect all items and populate filters
        initializeFilters();
        updatePriceDisplay();
    });

    function initializeFilters() {
        // Collect all items from the page
        const itemCards = document.querySelectorAll('[data-item]');
        const cities = new Set();
        
        itemCards.forEach(card => {
            const itemData = JSON.parse(card.getAttribute('data-item'));
            allItems.push({
                element: card.closest('.group'),
                ...itemData
            });
            
            // Extract city from description
            const cityMatch = itemData.description.match(/^([^,\.]+)/);
            if (cityMatch) {
                cities.add(cityMatch[1].trim());
            }
        });
        
        // Populate city filter
        const cityFilter = document.getElementById('cityFilter');
        Array.from(cities).sort().forEach(city => {
            const option = document.createElement('option');
            option.value = city;
            option.textContent = city;
            cityFilter.appendChild(option);
        });
    }

    function updatePriceDisplay() {
        const priceRange = document.getElementById('priceRange');
        const display = document.getElementById('priceRangeDisplay');
        display.textContent = `×¢×“ ${parseInt(priceRange.value).toLocaleString()} â‚ª`;
    }

    function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const selectedCity = document.getElementById('cityFilter').value;
        const maxPrice = parseInt(document.getElementById('priceRange').value);
        const sortBy = document.getElementById('sortBy').value;
        
        // Filter items
        let filteredItems = allItems.filter(item => {
            // Search filter
            if (searchTerm && !item.name.toLowerCase().includes(searchTerm)) {
                return false;
            }
            
            // City filter
            if (selectedCity && !item.description.includes(selectedCity)) {
                return false;
            }
            
            // Price filter
            if (item.price > maxPrice) {
                return false;
            }
            
            return true;
        });
        
        // Sort items
        filteredItems.sort((a, b) => {
            switch(sortBy) {
                case 'name-asc':
                    return a.name.localeCompare(b.name, 'he');
                case 'name-desc':
                    return b.name.localeCompare(a.name, 'he');
                case 'price-asc':
                    return a.price - b.price;
                case 'price-desc':
                    return b.price - a.price;
                default:
                    return 0;
            }
        });
        
        // Hide all items first
        allItems.forEach(item => {
            item.element.style.display = 'none';
        });
        
        // Show filtered and sorted items
        filteredItems.forEach((item, index) => {
            item.element.style.display = 'block';
            item.element.style.order = index;
        });
        
        // Update active filters display
        updateActiveFiltersDisplay(searchTerm, selectedCity, maxPrice);
        
        // Hide empty sections
        updateSectionVisibility();
        
        // Show results count
        showResultsCount(filteredItems.length, allItems.length);
    }

    function updateActiveFiltersDisplay(search, city, price) {
        const container = document.getElementById('activeFilters');
        let html = '';
        
        if (search) {
            html += `<span class="bg-[color:var(--color-black)] text-white px-3 py-1 rounded-full text-xs">×—×™×¤×•×©: ${search}</span>`;
        }
        if (city) {
            html += `<span class="bg-[color:var(--color-black)] text-white px-3 py-1 rounded-full text-xs">×¢×™×¨: ${city}</span>`;
        }
        if (price < 10000) {
            html += `<span class="bg-[color:var(--color-black)] text-white px-3 py-1 rounded-full text-xs">×¢×“ ${price.toLocaleString()} â‚ª</span>`;
        }
        
        if (html) {
            container.innerHTML = html;
            container.classList.remove('hidden');
        } else {
            container.classList.add('hidden');
        }
    }

    function updateSectionVisibility() {
        document.querySelectorAll('section[id]').forEach(section => {
            const visibleItems = section.querySelectorAll('.group[style*="display: block"]').length;
            if (visibleItems === 0) {
                section.style.display = 'none';
            } else {
                section.style.display = 'block';
            }
        });
    }

    function showResultsCount(filtered, total) {
        // Remove existing count if any
        const existingCount = document.getElementById('results-count');
        if (existingCount) existingCount.remove();
        
        // Add count below filters
        const filtersDiv = document.querySelector('.bg-white.rounded-lg.shadow-md');
        const countDiv = document.createElement('div');
        countDiv.id = 'results-count';
        countDiv.className = 'text-center text-sm text-gray-600 mt-4 font-sans';
        countDiv.innerHTML = `××¦×™×’ <strong>${filtered}</strong> ××ª×•×š <strong>${total}</strong> ×ª×•×¦××•×ª`;
        filtersDiv.appendChild(countDiv);
    }

    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('cityFilter').value = '';
        document.getElementById('priceRange').value = 10000;
        document.getElementById('sortBy').value = 'name-asc';
        updatePriceDisplay();
        
        // Show all items
        allItems.forEach(item => {
            item.element.style.display = 'block';
        });
        
        // Hide active filters
        document.getElementById('activeFilters').classList.add('hidden');
        
        // Show all sections
        document.querySelectorAll('section[id]').forEach(section => {
            section.style.display = 'block';
        });
        
        // Remove count
        const countDiv = document.getElementById('results-count');
        if (countDiv) countDiv.remove();
    }

    function toggleCart() {
        const sidebar = document.getElementById('cart-sidebar');
        if (sidebar.classList.contains('-translate-x-full')) {
            sidebar.classList.remove('-translate-x-full');
        } else {
            sidebar.classList.add('-translate-x-full');
        }
    }

    function updateCartUI() {
        console.log('ğŸ”µ Updating cart UI, cart items:', cart);
        
        const container = document.getElementById('cart-items');
        const countBadge = document.getElementById('cart-count');
        
        countBadge.innerText = cart.length;
        
        if (cart.length === 0) {
            container.innerHTML = '<p class="text-gray-400 text-center">×”×¡×œ ×¨×™×§</p>';
            return;
        }

        let html = '';
        let total = 0;
        cart.forEach(item => {
            total += parseInt(item.price);
            html += `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded">
                    <div>
                        <p class="font-bold text-sm">${item.name}</p>
                        <p class="text-xs text-gray-500">${item.price} â‚ª</p>
                    </div>
                </div>
            `;
        });
        
        html += `
            <div class="mt-4 pt-4 border-t border-gray-200 flex justify-between font-bold">
                <span>×¡×”"×›:</span>
                <span>${total} â‚ª</span>
            </div>
        `;
        
        console.log('ğŸ”µ Cart HTML generated, total:', total);
        container.innerHTML = html;
    }

    function addToCart(id, type, name, price, btnElement) {
        console.log('ğŸ”µ Adding to cart:', {id, type, name, price});
        
        fetch('/api/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ id, type, name, price }),
        })
        .then(response => response.json())
        .then(data => {
            console.log('ğŸ”µ Server response:', data);
            
            if (data.success) {
                // Fetch fresh cart
                fetchCart();
                
                // Show visual feedback on button
                if (btnElement) {
                    const originalText = btnElement.innerText;
                    btnElement.innerText = "× ×•×¡×£ âœ“";
                    btnElement.classList.add('bg-green-600', 'text-white', 'border-green-600');
                    setTimeout(() => {
                        btnElement.innerText = originalText;
                        btnElement.classList.remove('bg-green-600', 'text-white', 'border-green-600');
                    }, 2000);
                }
            } else {
                console.warn('âš ï¸ Item not added:', data.message);
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('âŒ Error adding to cart:', error);
            alert('×©×’×™××” ×‘×”×•×¡×¤×” ×œ×¡×œ');
        });
    }

    function fetchCart() {
        console.log('ğŸ”µ Fetching cart from server...');
        fetch('/api/cart')
        .then(res => res.json())
        .then(data => {
            console.log('ğŸ”µ Cart received:', data);
            cart = data.cart || [];
            console.log('ğŸ”µ Cart items:', cart);
            updateCartUI();
        })
        .catch(error => {
            console.error('âŒ Error fetching cart:', error);
        });
    }

    function clearCart() {
        fetch('/api/cart/clear', { method: 'POST' })
        .then(() => {
            cart = [];
            updateCartUI();
        });
    }

    async function saveEvent() {
        console.log('ğŸ”µ saveEvent called, cart:', cart);
        
        // Check if user is logged in
        const authResponse = await fetch('/api/current_user');
        const authData = await authResponse.json();
        console.log('ğŸ”µ Auth data:', authData);
        
        if (!authData.authenticated) {
            alert('×× × ×”×ª×—×‘×¨ ×ª×—×™×œ×” ×›×“×™ ×œ×©××•×¨ ××™×¨×•×¢');
            window.location.href = '/login';
            return;
        }
        
        // Check if cart is not empty
        if (cart.length === 0) {
            alert('×× × ×‘×—×¨ ×œ×¤×—×•×ª ×¡×¤×§ ××—×“');
            return;
        }
        
        console.log('ğŸ”µ Sending cart to server:', cart);
        
        try {
            // Save the event with all cart items
            const response = await fetch('/api/save_cart_to_event', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    cart_items: cart 
                })
            });
            
            const data = await response.json();
            console.log('ğŸ”µ Server response:', data);
            
            if (data.success) {
                // Clear cart after successful save
                await fetch('/api/cart/clear', { method: 'POST' });
                cart = [];
                updateCartUI();
                
                alert(data.message);
                window.location.href = data.redirect || '/dashboard';
            } else {
                alert(data.message);
            }
        } catch (error) {
            console.error('âŒ Error saving event:', error);
            alert('×©×’×™××” ×‘×©××™×¨×ª ×”××™×¨×•×¢');
        }
    }

    // Active category management
    function updateActiveCategory(clickedBtn) {
        // Remove active state from all buttons
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.remove('active-category');
        });
        // Add active state to clicked button
        clickedBtn.classList.add('active-category');
    }

    // ============ ADVANCED FEATURES ============

    // Global state
    let compareMode = false;
    let compareItems = [];
    let selectedCategories = [];
    let selectedCities = [];
    let minRating = 0;
    let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');

    // Smart Search with Autocomplete
    function handleSmartSearch(query) {
        const suggestions = document.getElementById('searchSuggestions');
        
        if (!query || query.length < 2) {
            suggestions.classList.add('hidden');
            applyFilters();
            return;
        }

        // Get all items
        const allCards = document.querySelectorAll('.supplier-card');
        const matches = [];
        
        allCards.forEach(card => {
            const name = card.dataset.name.toLowerCase();
            const category = card.dataset.category.toLowerCase();
            if (name.includes(query.toLowerCase()) || category.includes(query.toLowerCase())) {
                matches.push({
                    name: card.dataset.name,
                    category: card.dataset.category,
                    price: card.dataset.price
                });
            }
        });

        if (matches.length > 0) {
            suggestions.innerHTML = matches.slice(0, 5).map(m => `
                <div class="px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-0"
                     onclick="selectSuggestion('${m.name}')">
                    <div class="font-semibold text-sm">${m.name}</div>
                    <div class="text-xs text-gray-500">${m.category} â€¢ ${m.price} â‚ª</div>
                </div>
            `).join('');
            suggestions.classList.remove('hidden');
        } else {
            suggestions.classList.add('hidden');
        }

        applyFilters();
    }

    function selectSuggestion(name) {
        document.getElementById('searchInput').value = name;
        document.getElementById('searchSuggestions').classList.add('hidden');
        applyFilters();
    }

    // Multi-Select Category Filter
    function toggleCategoryDropdown() {
        const dropdown = document.getElementById('categoryDropdown');
        dropdown.classList.toggle('hidden');
        
        if (!dropdown.classList.contains('hidden') && dropdown.innerHTML.trim() === '') {
            // Populate categories
            const categories = new Set();
            document.querySelectorAll('.supplier-card').forEach(card => {
                categories.add(card.dataset.category);
            });
            
            dropdown.innerHTML = Array.from(categories).map(cat => `
                <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" value="${cat}" onchange="toggleCategory('${cat}')"
                           class="w-4 h-4 rounded border-gray-300 accent-[color:var(--color-espresso)]">
                    <span class="text-sm">${cat}</span>
                </label>
            `).join('');
        }
    }

    function toggleCategory(category) {
        const index = selectedCategories.indexOf(category);
        if (index > -1) {
            selectedCategories.splice(index, 1);
        } else {
            selectedCategories.push(category);
        }
        updateCategoryText();
        applyFilters();
    }

    function updateCategoryText() {
        const text = document.getElementById('categorySelectedText');
        if (selectedCategories.length === 0) {
            text.textContent = '×‘×—×¨ ×§×˜×’×•×¨×™×•×ª...';
            text.classList.add('text-gray-500');
        } else {
            text.textContent = selectedCategories.join(', ');
            text.classList.remove('text-gray-500');
        }
    }

    // Multi-Select City Filter
    function toggleCityDropdown() {
        const dropdown = document.getElementById('cityDropdown');
        dropdown.classList.toggle('hidden');
        
        if (!dropdown.classList.contains('hidden') && dropdown.innerHTML.trim() === '') {
            // Populate cities from data-item
            const cities = new Set();
            document.querySelectorAll('[data-item]').forEach(card => {
                try {
                    const item = JSON.parse(card.getAttribute('data-item'));
                    const desc = item.description || '';
                    const match = desc.match(/([×-×ª\s]+),/);
                    if (match) cities.add(match[1].trim());
                } catch(e) {}
            });
            
            dropdown.innerHTML = Array.from(cities).map(city => `
                <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" value="${city}" onchange="toggleCity('${city}')"
                           class="w-4 h-4 rounded border-gray-300 accent-[color:var(--color-espresso)]">
                    <span class="text-sm">${city}</span>
                </label>
            `).join('');
        }
    }

    function toggleCity(city) {
        const index = selectedCities.indexOf(city);
        if (index > -1) {
            selectedCities.splice(index, 1);
        } else {
            selectedCities.push(city);
        }
        updateCityText();
        applyFilters();
    }

    function updateCityText() {
        const text = document.getElementById('citySelectedText');
        if (selectedCities.length === 0) {
            text.textContent = '×‘×—×¨ ×¢×¨×™×...';
            text.classList.add('text-gray-500');
        } else {
            text.textContent = selectedCities.join(', ');
            text.classList.remove('text-gray-500');
        }
    }

    // Rating Filter
    function setMinRating(rating) {
        minRating = rating;
        document.querySelectorAll('.rating-btn').forEach(btn => {
            if (parseFloat(btn.dataset.rating) === rating) {
                btn.classList.add('bg-[color:var(--color-espresso)]', 'text-white', 'border-[color:var(--color-espresso)]');
            } else {
                btn.classList.remove('bg-[color:var(--color-espresso)]', 'text-white', 'border-[color:var(--color-espresso)]');
            }
        });
        applyFilters();
    }

    // Compare Mode
    function toggleCompareMode() {
        compareMode = !compareMode;
        const btn = document.getElementById('compareBtn');
        const checkboxes = document.querySelectorAll('.compare-checkbox');
        
        if (compareMode) {
            btn.classList.add('bg-[color:var(--color-espresso)]', 'text-white');
            checkboxes.forEach(cb => cb.classList.remove('hidden'));
        } else {
            btn.classList.remove('bg-[color:var(--color-espresso)]', 'text-white');
            checkboxes.forEach(cb => cb.classList.add('hidden'));
            compareItems = [];
        }
    }

    function toggleCompareItem(checkbox, itemId) {
        if (checkbox.checked) {
            if (compareItems.length >= 4) {
                alert('× ×™×ª×Ÿ ×œ×”×©×•×•×ª ×¢×“ 4 ×¡×¤×§×™× ×‘×œ×‘×“');
                checkbox.checked = false;
                return;
            }
            compareItems.push(itemId);
        } else {
            compareItems = compareItems.filter(id => id !== itemId);
        }

        if (compareItems.length >= 2) {
            showCompareButton();
        } else {
            hideCompareButton();
        }
    }

    function showCompareButton() {
        // You can add a floating "Compare Now" button here
        console.log('Compare items:', compareItems);
    }

    function hideCompareButton() {
        console.log('Not enough items to compare');
    }

    // Favorites
    function toggleFavorite(itemId, btn) {
        const index = favorites.indexOf(itemId);
        const heart = btn.querySelector('svg');
        
        if (index > -1) {
            favorites.splice(index, 1);
            heart.classList.remove('text-red-500');
            heart.classList.add('text-gray-400');
        } else {
            favorites.push(itemId);
            heart.classList.remove('text-gray-400');
            heart.classList.add('text-red-500');
        }
        
        localStorage.setItem('favorites', JSON.stringify(favorites));
    }

    // View Details
    function viewDetails(id, type) {
        alert(`×¤×¨×˜×™× ×¢×œ ${type} #${id} - ×‘×§×¨×•×‘!`);
        // TODO: Open modal with full details
    }

    // Enhanced Reset Filters
    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('priceRange').value = 20000;
        document.getElementById('sortBy').value = 'recommended';
        selectedCategories = [];
        selectedCities = [];
        minRating = 0;
        
        updateCategoryText();
        updateCityText();
        updatePriceDisplay();
        
        document.querySelectorAll('.rating-btn').forEach(btn => {
            btn.classList.remove('bg-[color:var(--color-espresso)]', 'text-white', 'border-[color:var(--color-espresso)]');
        });
        
        applyFilters();
    }

    // Update Results Counter
    function updateResultsCount() {
        const visibleCards = document.querySelectorAll('.supplier-card:not(.hidden)').length;
        document.getElementById('resultsCount').textContent = visibleCards;
    }

    // Enhanced applyFilters
    const originalApplyFilters = applyFilters;
    applyFilters = function() {
        originalApplyFilters();
        
        // Apply rating filter
        document.querySelectorAll('.supplier-card').forEach(card => {
            const rating = parseFloat(card.dataset.rating);
            if (rating < minRating) {
                card.classList.add('hidden');
                card.parentElement.classList.add('hidden');
            }
        });

        // Apply category filter
        if (selectedCategories.length > 0) {
            document.querySelectorAll('.supplier-card').forEach(card => {
                if (!selectedCategories.includes(card.dataset.category)) {
                    card.classList.add('hidden');
                    card.parentElement.classList.add('hidden');
                }
            });
        }

        // Apply city filter
        if (selectedCities.length > 0) {
            document.querySelectorAll('[data-item]').forEach(card => {
                try {
                    const item = JSON.parse(card.getAttribute('data-item'));
                    const desc = item.description || '';
                    const hasCity = selectedCities.some(city => desc.includes(city));
                    if (!hasCity) {
                        card.classList.add('hidden');
                        card.parentElement.classList.add('hidden');
                    }
                } catch(e) {}
            });
        }

        updateResultsCount();
    };

    // Initialize favorites on page load
    document.addEventListener('DOMContentLoaded', function() {
        favorites.forEach(favId => {
            const card = document.querySelector(`[data-id="${favId}"]`);
            if (card) {
                const heart = card.querySelector('svg');
                if (heart) {
                    heart.classList.remove('text-gray-400');
                    heart.classList.add('text-red-500');
                }
            }
        });
        
        updateResultsCount();
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('#categoryDropdown') && !event.target.closest('button[onclick="toggleCategoryDropdown()"]')) {
            document.getElementById('categoryDropdown').classList.add('hidden');
        }
        if (!event.target.closest('#cityDropdown') && !event.target.closest('button[onclick="toggleCityDropdown()"]')) {
            document.getElementById('cityDropdown').classList.add('hidden');
        }
        if (!event.target.closest('#searchSuggestions') && !event.target.closest('#searchInput')) {
            document.getElementById('searchSuggestions').classList.add('hidden');
        }
    });
</script>
{% endblock %}